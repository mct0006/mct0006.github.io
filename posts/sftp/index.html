<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<title>Setting up an SFTP Server in the Cloud | Adventures In</title>
<meta name=viewport content="width=device-width,minimum-scale=1">
<meta name=description content="Our team was recently presented with a project that required some infrastructure work&ndash;in particlar, one step in the project required a data transfer that needed to happen via sftp. As we didn&rsquo;t currently have an sftp server, we needed to get one set up.
In theory this seemed like an easy problem to solve, but it turned into quite a saga. Part of the difficulties were due to my own misunderstanding of the infrastructure on the side of the data owner; I made assumptions without fully fleshing out the details beforehand.">
<meta name=generator content="Hugo 0.89.4">
<meta name=ROBOTS content="NOINDEX, NOFOLLOW">
<link rel=stylesheet href=/ananke/css/main.min.css>
<meta property="og:title" content="Setting up an SFTP Server in the Cloud">
<meta property="og:description" content="Our team was recently presented with a project that required some infrastructure work&ndash;in particlar, one step in the project required a data transfer that needed to happen via sftp. As we didn&rsquo;t currently have an sftp server, we needed to get one set up.
In theory this seemed like an easy problem to solve, but it turned into quite a saga. Part of the difficulties were due to my own misunderstanding of the infrastructure on the side of the data owner; I made assumptions without fully fleshing out the details beforehand.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://mct0006.github.io/posts/sftp/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-11-20T06:51:51-05:00">
<meta property="article:modified_time" content="2021-11-20T06:51:51-05:00">
<meta itemprop=name content="Setting up an SFTP Server in the Cloud">
<meta itemprop=description content="Our team was recently presented with a project that required some infrastructure work&ndash;in particlar, one step in the project required a data transfer that needed to happen via sftp. As we didn&rsquo;t currently have an sftp server, we needed to get one set up.
In theory this seemed like an easy problem to solve, but it turned into quite a saga. Part of the difficulties were due to my own misunderstanding of the infrastructure on the side of the data owner; I made assumptions without fully fleshing out the details beforehand."><meta itemprop=datePublished content="2021-11-20T06:51:51-05:00">
<meta itemprop=dateModified content="2021-11-20T06:51:51-05:00">
<meta itemprop=wordCount content="1301">
<meta itemprop=keywords content><meta name=twitter:card content="summary">
<meta name=twitter:title content="Setting up an SFTP Server in the Cloud">
<meta name=twitter:description content="Our team was recently presented with a project that required some infrastructure work&ndash;in particlar, one step in the project required a data transfer that needed to happen via sftp. As we didn&rsquo;t currently have an sftp server, we needed to get one set up.
In theory this seemed like an easy problem to solve, but it turned into quite a saga. Part of the difficulties were due to my own misunderstanding of the infrastructure on the side of the data owner; I made assumptions without fully fleshing out the details beforehand.">
</head>
<body class="ma0 avenir bg-near-white">
<header>
<div class=bg-black>
<nav class="pv3 ph3 ph4-ns" role=navigation>
<div class="flex-l justify-between items-center center">
<a href=/ class="f3 fw2 hover-white no-underline white-90 dib">
Adventures In
</a>
<div class="flex-l items-center">
<ul class="pl0 mr3">
<li class="list f5 f4-ns fw4 dib pr3">
<a class="hover-white no-underline white-90" href=/about/ title="About page">
About
</a>
</li>
<li class="list f5 f4-ns fw4 dib pr3">
<a class="hover-white no-underline white-90" href=/posts/ title="Data Engineering page">
Data Engineering
</a>
</li>
</ul>
<a href=https://www.linkedin.com/in/mct0006/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a>
<a href=https://github.com/mct0006 target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel=noopener aria-label="follow on Github——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a>
</div>
</div>
</nav>
</div>
</header>
<main class=pb7 role=main>
<article class="flex-l flex-wrap justify-between mw8 center ph3">
<header class="mt4 w-100">
<aside class="instapaper_ignoref b helvetica tracked">
DATA ENGINEERING
</aside>
<div id=sharing class=mt3>
<a href="https://www.facebook.com/sharer.php?u=https://mct0006.github.io/posts/sftp/" class="facebook no-underline" aria-label="share on Facebook"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765 50.32h6.744V33.998h4.499l.596-5.624h-5.095l.007-2.816c0-1.466.14-2.253 2.244-2.253h2.812V17.68h-4.5c-5.405.0-7.307 2.729-7.307 7.317v3.377h-3.369v5.625h3.369V50.32zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg>
</a>
<a href="https://twitter.com/share?url=https://mct0006.github.io/posts/sftp/&text=Setting%20up%20an%20SFTP%20Server%20in%20the%20Cloud" class="twitter no-underline" aria-label="share on Twitter"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a>
<a href="https://www.linkedin.com/shareArticle?mini=true&url=https://mct0006.github.io/posts/sftp/&title=Setting%20up%20an%20SFTP%20Server%20in%20the%20Cloud" class="linkedin no-underline" aria-label="share on LinkedIn"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</a>
</div>
<h1 class="f1 athelas mt3 mb1">Setting up an SFTP Server in the Cloud</h1>
<p class=tracked>
By <strong>
Mary Clair Thompson
</strong>
</p>
<time class="f6 mv4 dib tracked" datetime=2021-11-20T06:51:51-05:00>November 20, 2021</time>
</header>
<div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p>Our team was recently presented with a project that required some infrastructure work&ndash;in particlar, one step in the project required a data transfer that needed to happen via sftp. As we didn&rsquo;t currently have an sftp server, we needed to get one set up.</p>
<p>In theory this seemed like an easy problem to solve, but it turned into quite a saga. Part of the difficulties were due to my own misunderstanding of the infrastructure on the side of the data owner; I made assumptions without fully fleshing out the details beforehand. That being said, I do think that the assumptions I made were quite reasonable.</p>
<p>At project kickoff, I knew that we needed an sftp endpoint; the data owner didn&rsquo;t give us any more details that would indicate that we needed to do anything particularly special with the setup. We already had several virtual machines in use on our team for development and production infrastructure, but for obvious reasons we didn&rsquo;t like the idea of giving anyone outside our team access to these boxes. So we decided to try setting up custom-built server for this purpose.</p>
<p>Our cloud provider doesn&rsquo;t currently offer built-in sftp functionality, so we had to do a bit of research to find an architecture that would suit our purposes. We found a really nice <a href=https://hub.docker.com/r/atmoz/sftp>docker image</a> that spins up a lightweight sftp server. To be clear, the image does only that&ndash;it doesn&rsquo;t provide ssh access and http requests to it aren&rsquo;t processed. That being said, this was actually exactly what we wanted; something super lightweight that would be relatively secure and easy to manage.</p>
<p>With that being decided, here&rsquo;s the architecture that we landed on: we would deploy the image using Azure Container Instances, and mount the container on a file share attached to one of our storage accounts. We would then be able to access the data via a Prefect job (Prefect is our workflow management tool, and I&rsquo;ll talk more about it in another post). All of the components would be living behind our Azure Virtual Network, which is helpfully peered with our org virtual network. This architecture is really nice and clean, with only the components and infrastructure absolutely required for sftp. In addition, since the server can only be used for sftp, and the file share doesn&rsquo;t expose anything about the underlying storage account, our security gurus were comfortable with the setup.</p>
<p>One security issue did come up with the data owner: they insisted that they could only authenticate with a username/password combination as opposed to our preferred method of ssh keys, but we didn&rsquo;t have any leverage to force the issue, so we would have to go with basic auth.</p>
<p>I hadn&rsquo;t worked with Azure Container Instances before so this was a great learning experience for me. Our setup for the container was quite customized&ndash;we needed to deploy it into a virtual network, mounted to a file share, and with some special functionality to get the authentication and ip bits correct. I ended up writing up a YAML file for deployment (reference <a href=https://docs.microsoft.com/en-us/azure/container-instances/container-instances-reference-yaml>here</a>), as this gave me a lot of flexibility for all of the customization.</p>
<p>It took a lot of tweaks to get it working, but once I got the YAML right the deployment was seamless, and I began to work with a colleague on scripting it for CI/CD purposes. In the meantime, I asked the data owner to make a test drop to the POC version to make sure that there weren&rsquo;t any issues that might come up before we built out the production version.</p>
<p>And here&rsquo;s where my assumptions came back to bite me: I made the (reasonable, I think) assumption that the sftp call would be made from an address within the organization&rsquo;s private IP space. When I mentioned to the data owner that this was where I was expecting the call to come from, he informed me that this would not be the case. The data would be coming from outside the organization and would need to be sent to a publicly available address.</p>
<p>As I implied above, the container instance only had a private IP (again, in our organization address space), so this was a problem. After conferring with my colleagues, we decided that the best solution would be to try to find a way to add a public IP to the existing container.</p>
<p>There are a couple of ways to do this in Azure: the most lightweight way would be to add an Application Gateway, which is a load balancer that allows for easy traffic management to containers. App Gateways are easy to set up and require minimal configuration, so this seemed like an ideal solution. However, after configuring it I realized that this solution wouldn&rsquo;t work for our purposes: the gateway needed to be able to make http requests to the underlying container. But our container only listens for sftp requests! After a lot of fiddling with the setup I finally decided that it really wasn&rsquo;t salvageable.</p>
<p>I knew of another potential solution involving setting up a firewall, public IP and routing tables, but I wanted to try to avoid this as it looked to be configuration-heavy. Instead, I tried a simpler solution: set up a container instance with only a public IP (Azure doesn&rsquo;t support creating instances with both a public and private IP), and whitelist that IP for the storage account. However, this new server was unable to talk to the storage account, and after a bit of research I realized something counterintuitive about ACI&rsquo;s: even though the instance boasts a public IP, this IP is only used for inbound traffic. Outbound traffic from the container could originate from any of a number of public IPs! So whitelisting wasn&rsquo;t going to work at all.</p>
<p>So I resorted to the &lsquo;complicated&rsquo; solution described <a href=https://docs.microsoft.com/en-us/azure/container-instances/container-instances-egress-ip-address>here</a>. To get this working, I had to configure a firewall, attach it to a subnet designated for it in the original virtual network, then create a public IP and attach it to the firewall-designated subnet. These steps allow public traffic to the IP to be funnelled into the virtual network. Next, I had to configure routes defining where traffic to this public IP should go: in this case, traffic to port 22 on the public IP would be routed through to port 22 on the private IP corresponding to the container instance.</p>
<p>With all of that being done, I crossed my fingers and tried to sftp to the public ip&ndash;to no avail. The process just seemed to hang. I was pretty bummed about this as I had spent quite a bit of time setting up the firewall solution and couldn&rsquo;t see any reason that it shouldn&rsquo;t work. However, in a troubleshooting call with a colleague, we realized that my process DID work&ndash;but only from non-organization IP addresses. I had been testing from onsite (with an org IP), but my colleague tested from offsite, with a non-org IP, and was able to sftp to the public address. Onsite, we can sftp to the private address (but again, not the public one).</p>
<p>Of course, this is far from an ideal setup in terms of the security implications. A public IP with basic authorization (and no MFA) is definitely a security risk, even with a firewall in place, and neither I nor the organization security team are thrilled about that aspect of the setup. Again, we don&rsquo;t have any leverage to force our client to improve their own setup, so we will have to live with the risk inherent in this configuration.</p>
<p>I learned a lot through this process&ndash;on the technical side I learned quite a bit about networking and using the Azure cli, but I also got a good lesson in not making assumptions about client infrastructure (even for internal clients).</p>
<ul class=pa0>
</ul>
<div class="mt6 instapaper_ignoref">
</div>
</div>
<aside class="w-30-l mt6-l">
</aside>
</article>
</main>
<footer class="bg-black bottom-0 w-100 pa3" role=contentinfo>
<div class="flex justify-between">
<a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://mct0006.github.io>
&copy; Adventures In 2021
</a>
<div>
<a href=https://www.linkedin.com/in/mct0006/ target=_blank class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><svg height="32" style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a>
<a href=https://github.com/mct0006 target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel=noopener aria-label="follow on Github——Opens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a>
</div>
</div>
</footer>
</body>
</html>